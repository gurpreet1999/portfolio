trigger:
  branches:
    include:
      - main

variables:
  - group: aws-secrets
  - group: docker-secrets

stages:

# ─────────────────────────────────────────────
- stage: Terraform
  displayName: 'Provision Infra'
  jobs:
    - job: TerraformApply
      displayName: 'Terraform Apply'
      pool:
        name: mypool
      steps:
        - checkout: self

        - script: |
            cd terraform
            terraform init -reconfigure -input=false


            terraform apply -auto-approve
          env:
            AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
            AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

# ─────────────────────────────────────────────
- stage: Docker
  displayName: 'Build Docker Image and Push'
  dependsOn: Terraform
  jobs:
    - job: DockerPush
      displayName: 'Docker Build and Push'
      pool:
        name: mypool
      steps:
        - checkout: self

        - script: |
            cd portfolio
            echo $(DOCKER_PASSWORD) | docker login -u $(DOCKER_USERNAME) --password-stdin
            docker build -t portfolio-site .
            docker tag portfolio-site gurpreet1999/portfolio-site:latest
            docker push gurpreet1999/portfolio-site:latest
          displayName: 'Build and Push Docker Image'

# ─────────────────────────────────────────────
- stage: Ansible
  displayName: 'Deploy with Ansible'
  dependsOn: Docker
  jobs:
    - job: DeployWithAnsible
      displayName: 'Deploy on EC2 with Ansible'
      pool:
        name: mypool
      steps:
        - checkout: self

        - task: DownloadSecureFile@1
          name: fetchPem
          inputs:
            secureFile: 'ok.pem'

        - script: |
            cd terraform
            terraform init
            EC2_IP=$(terraform output -raw webserver_ip)
            echo "Using EC2 IP: $EC2_IP"

            cp $(fetchPem.secureFilePath) ../ansible/ok.pem
            chmod 600 ../ansible/ok.pem

            cd ../ansible
            ansible-playbook deploy.yml -i "$EC2_IP," -u ubuntu --private-key ok.pem
          displayName: 'Run Ansible Playbook'
