# trigger:
#   branches:
#     include:
#       - main

# variables:
# - group: aws-secrets
# - group: docker-secrets

# stages:
# # - stage: Terraform
# #   displayName: 'Provision Infra'
# #   jobs:
# #     - job: TerraformApply
# #       displayName: 'Terraform Apply'
# #       pool:
# #         name: mypool
# #       steps:
# #         - checkout: self

# #         - script: |
# #             cd terraform
# #             terraform version
# #             terraform init
# #             terraform apply -auto-approve
# #           env:
# #             AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
# #             AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
# - stage : Docker
#   displayName: 'Build Docker Image and push'
#   jobs:
#     - job: Docker push
#       displayName: Docker push
#       pool:
#         name: mypool
#       steps:
#         - checkout: self

#         - script: |
#              cd portfolio
#              echo $(DOCKER_PASSWORD) | docker login -u $(DOCKER_USERNAME) --password-stdin
#              docker build -t portfolio-site .
#              docker tag portfolio-site gurpreet1999/portfolio-site:latest
#              docker push gurpreet1999/portfolio-site



# variables:
# - group: aws-secrets
# - group: docker-secrets

# stages:
# - stage: Docker
#   displayName: 'Build Docker Image and Push'
#   jobs:
#     - job: DockerPush
#       displayName: 'Docker Build and Push'
#       pool:
#         name: mypool
#       steps:
#         - checkout: self

#         - script: |
#             cd portfolio

            
#             echo $(DOCKER_PASSWORD) | docker login -u $(DOCKER_USERNAME) --password-stdin

           
#             docker build -t portfolio-site .

           
#             docker tag portfolio-site gurpreet1999/portfolio-site:latest

            
#             docker push gurpreet1999/portfolio-site:latest   "$EC2_IP,"
#           displayName: 'Build and Push Docker Image'

trigger:
  branches:
    include:
      - main

jobs:
  - job: DeployWithAnsible
    displayName: 'Deploy on EC2 with Ansible'
    pool:
      name: mypool

    steps:
      - checkout: self

      - task: DownloadSecureFile@1
        name: fetchPem
        inputs:
          secureFile: 'ok.pem'

      - script: |
          
          cd terraform
          EC2_IP=$(terraform output -raw webserver_ip)

         
          cp $(fetchPem.secureFilePath) ../ansible/ok.pem
          chmod 600 ../ansible/ok.pem

         
          ansible-playbook ../ansible/deploy.yml -i "13.233.53.185," -u ubuntu --private-key ../ansible/ok.pem
        displayName: 'Run Ansible Playbook with Inline Inventory'
