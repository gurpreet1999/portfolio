trigger:
  branches:
    include:
      - main

variables:
- group: aws-secrets     # Includes AWS creds for Terraform
- group: docker-secrets  # Includes Docker Hub username/password

stages:
- stage: Terraform
  jobs:
  - job: TerraformApply
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
    - script: |
        cd terraform
        terraform init
        terraform apply -auto-approve
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

- stage: DockerBuildAndPush
  dependsOn: Terraform
  jobs:
  - job: BuildAndPushDockerImage
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
    - script: |
        docker build -t $(DOCKER_USERNAME)/portfolio-site:latest .
        echo "$(DOCKER_PASSWORD)" | docker login -u "$(DOCKER_USERNAME)" --password-stdin
        docker push $(DOCKER_USERNAME)/portfolio-site:latest
      env:
        DOCKER_USERNAME: $(DOCKER_USERNAME)
        DOCKER_PASSWORD: $(DOCKER_PASSWORD)
