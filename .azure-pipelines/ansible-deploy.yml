trigger: none

resources:
  pipelines:
    - pipeline: dockerPipeline
      source: docker-build
      trigger:
        branches:
          include:
            - main

parameters:
  - name: ec2_ip
    type: string
    default: ''
    displayName: 'EC2 IP Address'
  - name: environment
    type: string
    default: ''
    displayName: 'Environment'

stages:
- stage: AnsibleDeploy
  displayName: 'Deploy with Ansible'
  condition: and(succeeded(), ne('${{ parameters.ec2_ip }}', ''))
  jobs:
    - deployment: DeployWithAnsible
      displayName: 'Deploy on EC2 with Ansible'
      environment: ${{ parameters.environment }}
      pool:
        name: mypool
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
              - task: DownloadSecureFile@1
                name: fetchPem
                inputs:
                  secureFile: 'ok.pem'
              - script: |
                  cp $(fetchPem.secureFilePath) ansible/ok.pem
                  chmod 600 ansible/ok.pem
                  cd ansible
                  ansible-playbook deploy.yml -i "${{ parameters.ec2_ip }}," -u ubuntu --private-key ok.pem
                displayName: 'Run Ansible Playbook'
